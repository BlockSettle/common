/*

***********************************************************************************
* Copyright (C) 2020 - 2020, BlockSettle AB
* Distributed under the GNU Affero General Public License (AGPL v3)
* See LICENSE or http://www.gnu.org/licenses/agpl.html
*
**********************************************************************************

*/
syntax = "proto3";

package Blocksettle.Communication.ApiServer;

import "bs_types.proto";

enum EidStatus {
    EID_STATUS_INVALID = 0;
    EID_STATUS_WAITING_SIGN = 10;
    EID_STATUS_TIMEOUT = 20;
    EID_STATUS_CANCELLED = 21;
    EID_STATUS_SERVER_ERROR = 22;
    EID_STATUS_ACCOUNT_NOT_FOUND = 23;
    EID_STATUS_REGISTRATION_FAILED = 24;
    EID_STATUS_ACCOUNT_NOT_VERIFIED = 25;
    EID_STATUS_SUCCESS = 30;
}

enum ErrorCode {
    ERROR_CODE_SERVER_ERROR = 0;
    ERROR_CODE_INVALID_REQUEST = 1;
}

message Order
{
   string id = 1;
   bs.types.OrderStatus status = 2;
   string status_text = 3;
   double timestamp = 4;
   string product_type = 5;
   bs.types.Side side = 6;
   double quantity = 8;
   double price = 9;
   double cut_off_price = 10;
   double trade_im = 11;
   bool   is_rollover = 12;
}

message ApiKey
{
    int32 id = 1;
    string token = 2;
    string allow = 3;
    string label = 4;
    string created = 5;
}

message Empty
{}


message Request
{
    message Authorize
    {
        string api_key = 1;
    }

    message EidRegister
    {
        message Answer
        {
            string question = 1;
            string answer = 2;
        }

        repeated Answer answers = 1;
    }

    message ResumeSession
    {
        string session_id = 1;
    }

    message MarketOrder
    {
        double amount = 1;
        bs.types.Side side = 2;
        string product_type = 3;
        double user_expected_price = 4;
        bool max_amount = 5;
    }

    message Subscribe
    {
        string product_type = 1;
    }

    message Unsubscribe
    {
        string product_type = 1;
    }

    message TradingDay
    {
        string product_type = 1;
    }

    message EstimateIm
    {
        string product_type = 1;
        double qty = 2;
        bs.types.Side side = 3;
    }

    message ProductFee
    {
        string product_type = 1;
    }

    message MaxTradeAmount
    {
        string product_type = 1;
        bs.types.Side side = 2;
    }

    message TradingStats
    {
        string product_type = 1;
    }

    message RevokeAddress
    {
        string address = 1;
    }

    message CreateIbanAgreementUrl
    {
        string country_short_code = 1;
        string iban = 2;
        string redirect = 3;
        bool sandbox = 4;
    }

    message GetIbanAccounts
    {
        string requisitions_id = 1;
    }

    message GetIbanAccountDetails
    {
        string account_ref = 1;
    }

    message WhitelistedAddressRequest
    {
        string  address         = 1;
        string  description     = 2;
    }

    message NewApiKey
    {
        string label = 1;
        string ip = 2;
    }

    message DeleteApiKey
    {
        int32 key_id = 1;
    }

    message CreateExternalAccount
    {
        string account_ref = 1;
    }

    message WithdrawToExternalAccount
    {
        string account_name = 1;
        double amount = 2;
        string ccy = 3;
    }

    message WithdrawBitcoin
    {
        string address = 1;
        double eur_amount = 2;
        double xbt_receive_amount = 3;
        double fee_amount = 4;
        double price = 5;
    }

    oneof data
    {
        Authorize                   authorize                   = 10;
        Empty                       eid_login                   = 11;
        EidRegister                 eid_register                = 12;
        Empty                       eid_cancel                  = 13;
        ResumeSession               resume_session              = 14;
        Empty                       logout                      = 15;
        MarketOrder                 market_order                = 16;
        Empty                       load_orders                 = 17;
        Empty                       load_balance                = 18;
        Subscribe                   subscribe                   = 19;
        Unsubscribe                 unsubscribe                 = 43;
        TradingDay                  trading_day                 = 20;
        EstimateIm                  estimate_im                 = 21;
        ProductFee                  product_fee                 = 22;
        MaxTradeAmount              max_trade_amount            = 23;
        TradingStats                trading_stats               = 24;

        bs.types.SubmitPricesData           submit_prices       = 25;
        bs.types.PullPricesData             pull_prices         = 26;

        WhitelistedAddressRequest   submit_address              = 27;
        Empty                       load_addresses              = 28;
        RevokeAddress               revoke_address              = 29;
        Empty                       load_deposit_address        = 30;
        CreateIbanAgreementUrl      create_iban_agreement       = 31;
        GetIbanAccounts             get_iban_accounts           = 32;
        GetIbanAccountDetails       get_iban_account_details    = 33;
        NewApiKey                   new_api_key                 = 34;
        Empty                       list_api_keys               = 35;
        DeleteApiKey                delete_api_key              = 36;
        Empty                       get_deposit_info                = 37;
        CreateExternalAccount       create_external_account         = 38;
        Empty                       get_all_external_accounts       = 39;
        WithdrawToExternalAccount   withdraw_to_external_account    = 40;
        WithdrawBitcoin             withdraw_bitcoin                = 41;
        Empty                       subscribe_withdraw_prices       = 44;
        Empty                       unsubscribe_withdraw_prices     = 45;
    }
}

message Response
{
    message Authorize
    {
        bool success = 1;
        string session_id = 2;
        string account_name = 3;
    }

    message EidLogin
    {
        string qr_code = 1;
    }

    message EidRegister
    {
        string qr_code = 1;
    }

    message ResumeSession
    {
        bool success = 1;
        string account_name = 2;
    }

    message MarketOrder
    {
        bool success = 1;
        string order_id = 2;
        string error_msg = 3;
        double price = 4;
    }

    message LoadOrders
    {
        repeated Order orders = 1;
    }

    message LoadBalance
    {
        repeated bs.types.Balance balances = 1;
    }

    message Subscribe
    {
        string product_type = 1;
        bool success = 2;
        string error_msg = 3;
    }

    message Unsubscribe
    {
        string product_type = 1;
        bool success = 2;
        string error_msg = 3;
    }

    message TradingDay
    {
        string product_type = 1;
        double time_to_cut_off = 2;
        double cut_off_at = 3;
        double last_cut_off_price = 4;
    }

    message EstimateIm
    {
        bool success = 1;
        string error_msg = 2;

        double expected_im_reservation = 10;
        double fee_amount = 12;
        string product_type = 14;
    }

    message ProductFee
    {
        bool   success        = 1;
        string error_msg      = 2;
        string product_type   = 3;
        double fee            = 4;
        string fee_ccy        = 5;
        double im             = 6;
    }

    message MaxTradeAmount
    {
        string product_type = 1;
        bs.types.Side side = 2;
        double qty = 3;
        double fee = 4;
    }

    message TradingStats
    {
        string product_type = 2;
        double daily_volume = 4;
        double open_interest = 5;
    }

    message CreateIbanAgreementUrl
    {
        bool error = 1;
        string message = 2;
        string ref = 3;
        string initiate = 4;
    }

    message GetIbanAccounts
    {
        bool loaded = 1;
        repeated string results = 2;
    }

    message GetIbanAccountDetails
    {
        bool loaded = 1;
        string resource_id = 2;
        string iban = 3;
        string currency = 4;
        string name = 5;
        string product = 6;
        string cash_account_type = 7;
    }

    message OrderUpdate
    {
        Order order = 1;
        bs.types.Action action = 2;
    }

    message MarketData
    {
        message Item
        {
            string quantity = 1;
            double bid = 2;
            double ask = 3;
        }

        string product_type = 1;
        repeated Item items = 2;
    }

    message EidLoginUpdate
    {
        EidStatus status = 1;
        string session_id = 2;
        string account_name = 3;
        string error_msg = 4;
    }

    message TradingClosed
    {
        string product_type = 1;
    }

    message Error
    {
        ErrorCode error_code = 1;
        string error_msg = 2;
    }

    message SubmitAddress
    {
        string  address         = 1;
        string  description     = 2;
        bool    success         = 3;
        string  error_msg       = 4;
        double  added_timestamp = 5;
    }

    message WhitelistedAddressResponse
    {
        string  address         = 1;
        string  description     = 2;
        double  added_timestamp = 3;
    }

    message LoadAddresses
    {
        repeated WhitelistedAddressResponse addresses = 1;
    }

    message RevokeAddress
    {
        string  address     = 1;
        bool    success     = 2;
        string  error_msg   = 3;
    }

    message LoadDepositAddress
    {
        string  address  = 1;
    }

    message UserNotify
    {
        string message = 1;
        string code = 2;
        string type = 3;
    }

    message NewApiKey
    {
        bool success = 1;
        string error_msg = 2;
        ApiKey key = 3;
        string secret = 4;
    }

    message ListApiKeys
    {
        bool success = 1;
        repeated ApiKey keys = 2;
    }

    message DeleteApiKey
    {
        bool success = 1;
        string error_msg = 2;
        int32 key_id = 3;
    }

    message GetDepositInfo
    {
        bool success = 1;
        string error_msg = 2;
        string data = 3;
    }

    message ResponseResult
    {
        bool success = 1;
        string error_msg = 2;
    }

    message GetAllExternalAccounts
    {
        bool success = 1;
        repeated string names = 2;
    }

    message ObligationRequest
    {
        string   delivery_id    = 1;
        string   currency       = 2;
        double   amount         = 3;
        string   bs_address     = 4;
    }

    message UpdateWithdrawPrices
    {
        double sell_price = 1;
        double buy_price = 2;
        double network_fee = 3;
        double min_xbt_amount = 4;
   }

    oneof data
    {
        Authorize               authorize                   = 10;
        EidLogin                eid_login                   = 11;
        EidRegister             eid_register                = 12;
        ResumeSession           resume_session              = 13;
        Empty                   logout                      = 14;
        MarketOrder             market_order                = 15;
        LoadOrders              load_orders                 = 16;
        LoadBalance             load_balance                = 17;
        Subscribe               subscribe                   = 18;
        Unsubscribe             unsubscribe                 = 48;
        TradingDay              trading_day                 = 19;
        EstimateIm              estimate_im                 = 20;
        ProductFee              product_fee                 = 21;
        MaxTradeAmount          max_trade_amount            = 22;
        TradingStats            trading_stats               = 23;
        SubmitAddress           submit_address              = 24;
        LoadAddresses           load_addresses              = 25;
        RevokeAddress           revoke_address              = 26;
        LoadDepositAddress      load_deposit_address        = 27;
        CreateIbanAgreementUrl  create_iban_agreement       = 28;
        GetIbanAccounts         get_iban_accounts           = 29;
        GetIbanAccountDetails   get_iban_account_details    = 30;
        NewApiKey               new_api_key                 = 38;
        ListApiKeys             list_api_keys               = 39;
        DeleteApiKey            delete_api_key              = 40;
        GetDepositInfo                get_deposit_info               = 41;
        ResponseResult          create_external_account     = 42;
        GetAllExternalAccounts        get_all_external_accounts      = 43;
        ResponseResult          withdraw_to_external_account= 44;
        ResponseResult          withdraw_bitcoin            = 45;
        ObligationRequest       obligation_request          = 46;
        ResponseResult          subscribe_withdraw_prices   = 47;
        ResponseResult          unsubscribe_withdraw_prices = 49;

        MarketData              market_data                 = 31;
        Error                   fatal_error                 = 32;
        EidLoginUpdate          eid_login_update            = 33;
        OrderUpdate             order_update                = 34;
        TradingClosed           trading_closed              = 35;
        Empty                   session_replaced            = 36;
        UserNotify              user_notify                 = 37;
        UpdateWithdrawPrices    update_withdraw_prices      = 50;
    }
}
